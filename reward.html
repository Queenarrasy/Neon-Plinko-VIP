<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REWARD REFERRAL - NEON PLINKO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root { --pink: #ff0077; --blue: #00d4ff; --yellow: #fbff00; --bg: #070816; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; padding: 20px; }
        
        .btn-back { color: var(--blue); text-decoration: none; font-weight: 900; font-size: 12px; display: flex; align-items: center; gap: 5px; margin-bottom: 20px; text-transform: uppercase; }

        /* HEADER BOX */
        .reward-header { 
            background: linear-gradient(145deg, rgba(255,0,119,0.1), rgba(0,212,255,0.1));
            border: 1px solid var(--blue); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 25px;
            box-shadow: 0 0 20px rgba(0,212,255,0.2);
        }
        .reward-header h2 { color: var(--yellow); margin: 0; font-size: 18px; text-transform: uppercase; }
        .reward-header p { font-size: 11px; color: #aaa; margin: 10px 0; line-height: 1.5; }
        .bonus-tag { background: var(--pink); color: white; padding: 5px 15px; border-radius: 50px; font-weight: 900; font-size: 12px; display: inline-block; }

        /* REFERRAL CODE BOX (NEW) */
        .referral-code-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--blue);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        .code-box {
            background: #000;
            border: 1px dashed var(--blue);
            color: var(--yellow);
            padding: 10px;
            font-size: 20px;
            font-family: monospace;
            font-weight: 900;
            letter-spacing: 3px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: inset 0 0 10px rgba(0, 212, 255, 0.2);
        }
        .copy-hint { font-size: 9px; color: #666; text-transform: uppercase; }

        /* DAILY REWARD SECTION */
        .daily-reward-card {
            background: rgba(255, 255, 255, 0.05); border: 2px dashed var(--yellow);
            border-radius: 15px; padding: 15px; text-align: center; margin-bottom: 20px;
        }
        .daily-warning { font-size: 9px; color: var(--pink); margin-top: 8px; font-style: italic; line-height: 1.3; }
        .btn-daily {
            background: var(--yellow); color: black; border: none; padding: 10px 20px;
            border-radius: 10px; font-weight: 900; cursor: pointer; width: 100%; margin-top: 10px;
            box-shadow: 0 0 10px var(--yellow);
        }
        .btn-daily:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        /* KOTAK MASUK SECTION */
        .admin-inbox { 
            margin-bottom: 25px; 
            border: 1px solid rgba(0, 212, 255, 0.3); 
            border-radius: 15px; 
            padding: 15px; 
            background: rgba(0, 0, 0, 0.6);
        }
        .inbox-title { 
            font-size: 13px; color: var(--blue); font-weight: 900; margin-bottom: 12px; 
            text-transform: uppercase; display: flex; align-items: center; gap: 8px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1); padding-bottom: 8px;
        }
        .msg-card {
            background: rgba(255, 255, 255, 0.03); border: 1px solid #222; padding: 12px; border-radius: 10px; margin-bottom: 10px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .msg-text { font-size: 11px; margin-bottom: 10px; color: #ddd; line-height: 1.4; }
        .btn-claim-gift { 
            background: linear-gradient(to right, var(--blue), #0088ff); color: white; border: none; 
            padding: 7px 15px; border-radius: 6px; font-size: 11px; font-weight: 900; cursor: pointer; 
            width: 100%; box-shadow: 0 4px 10px rgba(0, 212, 255, 0.3);
        }

        /* STATS */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: rgba(0,0,0,0.4); border: 1px solid #333; padding: 15px; border-radius: 15px; text-align: center; }
        .stat-card small { font-size: 9px; color: #888; text-transform: uppercase; }
        .stat-card div { font-size: 16px; font-weight: 900; margin-top: 5px; }

        /* KLAIM BUTTON */
        .btn-claim { 
            width: 100%; padding: 18px; border-radius: 15px; border: none; font-weight: 900; font-size: 16px; 
            text-transform: uppercase; cursor: pointer; transition: 0.3s; margin-bottom: 10px;
        }
        .btn-active { background: var(--yellow); color: black; box-shadow: 0 0 20px var(--yellow); }
        .btn-locked { background: #1a1a1a; color: #444; cursor: not-allowed; border: 1px solid #333; }

        .day-info { font-size: 10px; text-align: center; margin-bottom: 20px; font-weight: bold; }

        /* HISTORY LIST */
        .history-section h3 { font-size: 14px; color: var(--blue); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .referral-item { 
            background: rgba(255,255,255,0.03); border: 1px solid #222; padding: 12px 15px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .user-info b { font-size: 14px; display: block; color: #fff; }
        .user-info small { font-size: 9px; color: #555; }
        .status-badge { font-size: 9px; font-weight: 900; padding: 5px 10px; border-radius: 50px; text-transform: uppercase; }
        
        .status-aktif { background: rgba(0, 255, 136, 0.1); color: #00ff88; border: 1px solid #00ff88; }
        .status-belum { background: rgba(255, 255, 255, 0.05); color: #777; border: 1px solid #444; }

        #empty-state { text-align: center; padding: 40px 0; color: #444; font-size: 12px; }

        /* LOADING */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 2000000;
        }

        #neon-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 10000;
        }
        .neon-modal {
            background: #0d0f26; border: 2px solid var(--pink); border-radius: 25px;
            padding: 30px; text-align: center; width: 85%; max-width: 320px;
            box-shadow: 0 0 40px var(--pink), inset 0 0 15px rgba(255, 0, 119, 0.2);
            animation: zoomModal 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes zoomModal { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .neon-modal h2 { color: var(--pink); text-shadow: 0 0 10px var(--pink); margin-top: 0; letter-spacing: 2px; text-transform: uppercase; }
        .neon-modal p { color: #fff; line-height: 1.5; margin-bottom: 25px; font-size: 15px; font-weight: 600; }
        .neon-modal-btn {
            background: linear-gradient(90deg, var(--blue), #0088ff); border: none;
            padding: 12px 0; width: 100%; border-radius: 50px; color: #000;
            font-weight: 900; cursor: pointer; box-shadow: 0 0 15px var(--blue);
            text-transform: uppercase;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="width:40px; height:40px; border:4px solid var(--blue); border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite;"></div>
        <p style="color:var(--blue); font-size:10px; margin-top:10px;">SYNCING CLOUD...</p>
    </div>

    <div id="neon-modal-overlay">
        <div class="neon-modal">
            <h2 id="modal-title" data-i18n="modal-title-info">INFO</h2>
            <p id="modal-msg">Pesan sistem di sini.</p>
            <button class="neon-modal-btn" onclick="closeNeonModal()" data-i18n="btn-understand">MENGERTI</button>
        </div>
    </div>

    <a href="game.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i> <span data-i18n="btn-back">KEMBALI KE GAME</span></a>

    <div class="referral-code-container">
        <small style="color: var(--blue); font-weight: 900;" data-i18n="label-your-code">KODE REFERRAL ANDA</small>
        <div class="code-box" id="my-referral-code" onclick="copyReferralCode()">
            MEMUAT...
        </div>
        <div class="copy-hint" data-i18n="hint-copy">Klik kode di atas untuk menyalin</div>
    </div>

    <div class="daily-reward-card">
        <small style="color: var(--yellow); font-weight: 900;" data-i18n="label-daily">DAILY CHECK-IN</small>
        <div style="font-size: 18px; font-weight: 900; margin: 5px 0;">IDR 1.000</div>
        <button id="btn-daily" class="btn-daily" onclick="claimDailyReward()" data-i18n="btn-claim-daily">KLAIM HADIAH HARIAN</button>
        <div class="daily-warning" data-i18n="daily-warning">
            * Segera klaim jatah harian Anda. Jatah yang terlewatkan 1 hari akan otomatis hangus dan tidak dapat diakumulasi.
        </div>
    </div>

    <div class="admin-inbox">
        <div class="inbox-title"><i class="fa-solid fa-envelope"></i> <span data-i18n="label-inbox">KOTAK MASUK</span></div>
        <div id="inbox-list">
            <div style="font-size:11px; color:#555; text-align:center; padding:10px;">Mengecek pesan dari Admin...</div>
        </div>
    </div>

    <div class="reward-header">
        <h2 data-i18n="referral-title">PROGRAM REFERRAL VIP</h2>
        <p data-i18n="referral-desc">Setiap teman yang mendaftar dan melakukan deposit pertama, Anda berhak mendapatkan bonus saldo.</p>
        <div class="bonus-tag" data-i18n="bonus-tag">BONUS IDR 5.000 / TEMAN</div>
    </div>

    <div class="stat-grid">
        <div class="stat-card">
            <small data-i18n="total-invite">Total Undangan</small>
            <div id="total-invite">0</div>
        </div>
        <div class="stat-card">
            <small data-i18n="reward-available">Reward Tersedia</small>
            <div id="total-reward" style="color: var(--yellow);">IDR 0</div>
        </div>
    </div>

    <div id="day-warning" class="day-info" style="color: var(--pink);">
        <i class="fa-solid fa-lock"></i> <span data-i18n="sunday-only">Klaim hanya tersedia hari Minggu</span>
    </div>
    
    <button id="btn-klaim-reward" class="btn-claim btn-locked" data-i18n="btn-claim-sunday">
        KLAIM REWARD (MINGGU)
    </button>

    <div class="history-section">
        <h3><i class="fa-solid fa-users"></i> <span data-i18n="invite-history">RIWAYAT UNDANGAN</span></h3>
        <div id="referral-list">
            </div>
    </div>

    <script src="global.js"></script>
    <script>
        // --- FUNGSI TAMBAHAN ADMIN (CHECK INBOX) ---
        async function checkInbox() {
            const user = localStorage.getItem('user_session');
            const res = await fetchCloud({ action: "getInbox", username: user });
            
            if (res && res.length > 0) {
                res.forEach(msg => {
                    if (msg.status === "UNCLAIMED") {
                        // Menggunakan showNeonAlert yang ada di global.js
                        if(typeof showNeonAlert === 'function') {
                            showNeonAlert(`Pesan: ${msg.pesan}\nHadiah: IDR ${msg.hadiah}`, "KOTAK MASUK");
                        } else {
                            showNeonModal(`Pesan: ${msg.pesan}\nHadiah: IDR ${msg.hadiah}`, "KOTAK MASUK");
                        }

                        // Logika Klaim: Tambah saldo & tandai sudah diklaim
                        if (parseInt(msg.hadiah) > 0) {
                            if(typeof updateSaldo === 'function') {
                                updateSaldo(parseInt(msg.hadiah));
                            } else {
                                let saldo = parseInt(localStorage.getItem('saldo_permainan')) || 0;
                                localStorage.setItem('saldo_permainan', saldo + parseInt(msg.hadiah));
                            }
                            fetchCloud({ action: "claimInbox", id: msg.id });
                        }
                    }
                });
            }
        }

        // --- LOGIKA KODE REFERRAL UNIK ---
        function generateMyCode() {
            const username = localStorage.getItem('user_session') || "MEMBER";
            let myCode = localStorage.getItem('unique_referral_code');
            
            if (!myCode) {
                const cleanUser = username.substring(0, 3).toUpperCase().replace(/\s/g, 'X');
                const randomNum = Math.floor(1000 + Math.random() * 9000);
                myCode = cleanUser + randomNum;
                localStorage.setItem('unique_referral_code', myCode);
            }
            document.getElementById('my-referral-code').innerText = myCode;
        }

        function copyReferralCode() {
            const code = document.getElementById('my-referral-code').innerText;
            const lang = localStorage.getItem('appLang') || 'id';
            const msg = lang === 'id' ? `Kode Referral ${code} berhasil disalin!` : `Referral Code ${code} copied successfully!`;
            const title = lang === 'id' ? "BERHASIL" : "SUCCESS";

            navigator.clipboard.writeText(code).then(() => {
                showNeonModal(msg, title);
            }).catch(() => {
                alert("Referral: " + code);
            });
        }

        // --- CUSTOM MODAL ENGINE ---
        function showNeonModal(msg, title = "INFO") {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('neon-modal-overlay').style.display = 'flex';
        }

        function closeNeonModal() {
            document.getElementById('neon-modal-overlay').style.display = 'none';
        }

        // --- LOGIKA REWARD HARIAN (SYNC CLOUD) ---
        async function claimDailyReward() {
            const username = localStorage.getItem('user_session');
            const today = new Date().toDateString();
            const lang = localStorage.getItem('appLang') || 'id';

            document.getElementById('loading-overlay').style.display = 'flex';

            const result = await fetchCloud({
                action: "deposit", 
                username: username,
                amount: 1000,
                method: "DAILY CHECK-IN",
                date: new Date().toLocaleString('id-ID')
            });

            document.getElementById('loading-overlay').style.display = 'none';

            if (result === "SUCCESS") {
                let saldoSekarang = parseInt(localStorage.getItem('saldo_permainan')) || 0;
                localStorage.setItem('saldo_permainan', saldoSekarang + 1000);
                localStorage.setItem('last_daily_claim', today);
                
                const msg = lang === 'id' ? "Selamat! Hadiah check-in IDR 1.000 telah ditambahkan ke saldo Anda." : "Congratulations! IDR 1,000 check-in reward has been added to your balance.";
                showNeonModal(msg, lang === 'id' ? "KLAIM BERHASIL" : "CLAIM SUCCESS");
                setTimeout(() => { location.reload(); }, 2000);
            } else {
                showNeonModal("Gagal klaim, periksa koneksi internet.", "ERROR");
            }
        }

        function checkDailyStatus() {
            const lastClaim = localStorage.getItem('last_daily_claim');
            const today = new Date().toDateString();
            const btn = document.getElementById('btn-daily');
            const lang = localStorage.getItem('appLang') || 'id';

            if (lastClaim === today) {
                btn.disabled = true;
                btn.innerText = lang === 'id' ? "SUDAH DIKLAIM HARI INI" : "ALREADY CLAIMED TODAY";
            }
        }

        // --- LOGIKA KOTAK MASUK (SYNC CLOUD) ---
        async function syncInbox() {
            const user = localStorage.getItem('user_session');
            const list = document.getElementById('inbox-list');
            const lang = localStorage.getItem('appLang') || 'id';

            const messages = await fetchCloud({ action: "get_inbox", username: user });

            if (messages && messages.length > 0) {
                list.innerHTML = "";
                messages.forEach((msg, index) => {
                    const btnText = lang === 'id' ? `AMBIL IDR ${msg.nominal.toLocaleString()}` : `TAKE IDR ${msg.nominal.toLocaleString()}`;
                    const giftTitle = lang === 'id' ? "HADIAH ADMIN" : "ADMIN GIFT";
                    list.innerHTML += `
                        <div class="msg-card">
                            <div class="msg-text">
                                <i class="fa-solid fa-gift" style="color:var(--yellow)"></i> <b>${giftTitle}</b><br>
                                ${msg.pesan}
                            </div>
                            <button class="btn-claim-gift" onclick="claimAdminGiftCloud('${msg.id}', ${msg.nominal})">
                                ${btnText}
                            </button>
                        </div>
                    `;
                });
            } else {
                const noMsg = lang === 'id' ? "Tidak ada pesan atau hadiah baru." : "No new messages or rewards.";
                list.innerHTML = `<div style="font-size:11px; color:#555; text-align:center; padding:10px;">${noMsg}</div>`;
            }
        }

        async function claimAdminGiftCloud(giftId, amount) {
            const user = localStorage.getItem('user_session');
            const lang = localStorage.getItem('appLang') || 'id';
            
            document.getElementById('loading-overlay').style.display = 'flex';

            const result = await fetchCloud({
                action: "claim_reward",
                username: user,
                reward_id: giftId
            });

            document.getElementById('loading-overlay').style.display = 'none';

            if (result === "SUCCESS") {
                let saldo = parseInt(localStorage.getItem('saldo_permainan')) || 0;
                localStorage.setItem('saldo_permainan', saldo + amount);
                
                const msgSuccess = lang === 'id' ? "Hadiah IDR " + amount.toLocaleString() + " diterima!" : "Gift IDR " + amount.toLocaleString() + " received!";
                showNeonModal(msgSuccess, "SUCCESS");
                setTimeout(() => { location.reload(); }, 2000);
            } else {
                showNeonModal("Gagal klaim hadiah.", "FAILED");
            }
        }

        // --- LOGIKA REFERRAL ---
        function renderRewardPage() {
            generateMyCode(); 
            checkDailyStatus();
            syncInbox(); 
            checkInbox(); // Tambahan: Cek pesan klaim dari admin

            const listContainer = document.getElementById('referral-list');
            const btnKlaim = document.getElementById('btn-klaim-reward');
            const dayWarning = document.getElementById('day-warning');
            const lang = localStorage.getItem('appLang') || 'id';
            
            const databaseRef = JSON.parse(localStorage.getItem('referral_database')) || [];
            const d = new Date();
            const isSunday = d.getDay() === 0;

            if (isSunday) {
                btnKlaim.classList.remove('btn-locked');
                btnKlaim.classList.add('btn-active');
                btnKlaim.innerText = lang === 'id' ? "KLAIM REWARD SEKARANG" : "CLAIM REWARD NOW";
                btnKlaim.onclick = function() { kirimDataKeAdmin(databaseRef); };
                
                const unlockText = lang === 'id' ? "HARI MINGGU: Gerbang klaim terbuka!" : "SUNDAY: Claim gate is open!";
                dayWarning.innerHTML = `<i class="fa-solid fa-unlock"></i> ${unlockText}`;
                dayWarning.style.color = "#00ff88";
            }

            if (databaseRef.length === 0) {
                const emptyMsg = lang === 'id' ? "Belum ada teman yang menggunakan kode Anda." : "No friends have used your code yet.";
                listContainer.innerHTML = `<div id="empty-state">${emptyMsg}</div>`;
                return;
            }

            let totalAktif = 0;
            listContainer.innerHTML = "";

            databaseRef.forEach(user => {
                const isAktif = user.hasDeposited === true;
                if (isAktif) totalAktif++;

                const statusText = isAktif ? (lang === 'id' ? 'AKTIF' : 'ACTIVE') : (lang === 'id' ? 'BELUM AKTIF' : 'INACTIVE');

                listContainer.innerHTML += `
                    <div class="referral-item">
                        <div class="user-info">
                            <b>${user.invitedUser}</b>
                            <small>Join: ${user.date}</small>
                        </div>
                        <span class="status-badge ${isAktif ? 'status-aktif' : 'status-belum'}">
                            ${statusText}
                        </span>
                    </div>
                `;
            });

            document.getElementById('total-invite').innerText = databaseRef.length;
            document.getElementById('total-reward').innerText = "IDR " + (totalAktif * 5000).toLocaleString();
        }

        function kirimDataKeAdmin(data) {
            const lang = localStorage.getItem('appLang') || 'id';
            const userSekarang = localStorage.getItem('user_session') || "MEMBER_VIP";
            const myCode = localStorage.getItem('unique_referral_code') || "NONE";
            const aktifOnly = data.filter(u => u.hasDeposited === true);
            
            if (aktifOnly.length === 0) {
                const rejectMsg = lang === 'id' ? "Anda belum memiliki undangan yang berstatus AKTIF (sudah deposit)." : "You don't have any ACTIVE invited users (already deposited) yet.";
                const rejectTitle = lang === 'id' ? "KLAIM DITOLAK" : "CLAIM REJECTED";
                showNeonModal(rejectMsg, rejectTitle);
                return;
            }

            const totalBonus = aktifOnly.length * 5000;
            const detailTeman = aktifOnly.map(u => u.invitedUser).join(", ");
            const pesan = `HALO ADMIN NEON PLINKO\nSAYA INGIN KLAIM REWARD REFERRAL\nUsername: ${userSekarang}\nKode Referral: ${myCode}\nBonus: IDR ${totalBonus.toLocaleString()}\nUser: ${detailTeman}`;
            const linkWA = `https://wa.me/6289510249551?text=${encodeURIComponent(pesan)}`;
            window.open(linkWA, '_blank');
        }

        window.onload = () => {
            if(typeof applyLanguage === 'function') applyLanguage();
            renderRewardPage();
        };
    </script>
    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</body>
</html>
