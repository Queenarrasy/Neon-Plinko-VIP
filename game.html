<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON PLINKO VIP - FIXED</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --pink: #ff0077;
            --blue: #0044ff;
            --yellow: #fbff00;
            --white: #ffffff;
            --bg: #03040a;
            --neon-pink: 0 0 15px var(--pink), 0 0 30px var(--pink);
            --neon-blue: 0 0 15px var(--blue);
            --neon-white: 0 0 10px var(--white), 0 0 20px rgba(255,255,255,0.5);
            --neon-yellow: 0 0 15px var(--yellow), 0 0 25px var(--yellow);
        }

        body {
            background: var(--bg); color: white;
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column;
            background-image: radial-gradient(circle at 50% 50%, #0a0b1e 0%, var(--bg) 80%);
        }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: rgba(5, 7, 20, 0.95);
            border-bottom: 2px solid var(--blue); z-index: 1000;
        }

        .balance-box {
            background: #000; border: 2px solid var(--pink);
            border-radius: 50px; padding: 8px 25px; text-align: center;
            box-shadow: var(--neon-pink);
        }

        #display-saldo { font-size: 17px; font-weight: 900; color: var(--white); text-shadow: 0 0 5px white; }

        /* GAME BOARD */
        #game-board {
            position: relative; width: 100%; height: 380px;
            margin-top: 10px; overflow: visible; background: transparent;
        }

        .peg {
            position: absolute; width: 6px; height: 6px;
            background: var(--white); border-radius: 50%;
            box-shadow: var(--neon-white); z-index: 5;
            transform: translate(-50%, -50%);
        }

        .peg.hit {
            background: var(--yellow) !important;
            box-shadow: var(--neon-yellow) !important;
            transform: translate(-50%, -50%) scale(1.8);
            transition: 0.05s;
        }

        .ball {
            position: absolute; width: 12px; height: 12px;
            background: radial-gradient(circle at 30% 30%, #fff, var(--pink));
            border-radius: 50%; box-shadow: var(--neon-pink);
            z-index: 10; transform: translate(-50%, -50%); pointer-events: none;
        }

        /* MULTIPLIERS & EFEK KOTAK */
        .multiplier-row {
            display: flex; justify-content: center; gap: 4px;
            padding: 0 15px; margin-bottom: 10px;
        }

        .slot {
            flex: 1; height: 32px; display: flex; align-items: center;
            justify-content: center; font-size: 10px; font-weight: 900;
            border-radius: 6px; color: #000; transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* EFEK KOTAK MENYALA */
        .slot.active {
            transform: translateY(-8px) scale(1.15);
            filter: brightness(1.5);
            box-shadow: 0 0 20px var(--white);
            z-index: 100;
        }

        .s-high { background: var(--pink); }
        .s-mid { background: var(--yellow); }
        .s-low { background: var(--blue); color: white !important; }

        /* PAPAN SCORE MELAYANG */
        #floating-score {
            position: fixed; top: 10px; right: 10px;
            background: rgba(0,0,0,0.85); border: 2px solid var(--yellow);
            border-radius: 10px; padding: 10px 15px;
            box-shadow: var(--neon-yellow); z-index: 2000;
            display: none; min-width: 100px; text-align: center;
            animation: scoreIn 0.3s ease-out;
        }
        @keyframes scoreIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* CONTROLS */
        .controls { padding: 15px; background: #050714; border-top: 2px solid var(--blue); }
        
        .mode-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        
        .btn-mode {
            background: #000; border: 1px solid var(--pink); color: white;
            padding: 8px 15px; border-radius: 10px; font-size: 11px; font-weight: 900; cursor: pointer;
        }

        .btn-mode.active { background: var(--pink); box-shadow: var(--neon-pink); }

        .bet-area {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 15px;
            border: 1px solid var(--blue); margin-bottom: 15px;
        }

        .btn-play {
            width: 100%; padding: 16px; border-radius: 50px;
            background: linear-gradient(90deg, #aa0055, #0022aa);
            color: white; font-weight: 900; font-size: 16px;
            border: 2px solid var(--yellow); text-transform: uppercase;
        }

        /* NAV BOTTOM */
        .nav-bottom {
            display: grid; grid-template-columns: repeat(4, 1fr);
            background: #000; padding: 12px 0; border-top: 1px solid #222;
        }

        .nav-item { color: white; font-size: 9px; text-align: center; text-decoration: none; opacity: 0.6; }
        .nav-item i { font-size: 18px; display: block; margin-bottom: 3px; }
        .nav-item.active { opacity: 1; color: var(--yellow); }

        .win-popup { position: absolute; font-weight: 900; font-size: 20px; animation: quickFadeUp 0.8s forwards; z-index: 100; text-shadow: 0 0 5px black; pointer-events: none;}
        @keyframes quickFadeUp { 0% { opacity: 0; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-30px); } 100% { opacity: 0; transform: translateY(-50px); } }
    </style>
</head>
<body>

    <audio id="sfx-hit" src="https://assets.mixkit.co/active_storage/sfx/2577/2577-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <div id="floating-score">
        <div style="font-size: 9px; color: var(--white); opacity: 0.7;">LAST WIN</div>
        <div id="score-amount" style="font-size: 16px; font-weight: 900; color: var(--yellow);">IDR 0</div>
    </div>

    <div class="header">
        <div onclick="location.href='profil.html'"><i class="fa-solid fa-user-circle" style="color: var(--pink); font-size: 24px;"></i></div>
        <div class="balance-box">
            <div id="display-saldo">IDR 0</div>
        </div>
        <div onclick="location.href='settings.html'"><i class="fa-solid fa-gear" style="color: var(--yellow); font-size: 22px;"></i></div>
    </div>

    <div id="game-board"></div>

    <div class="multiplier-row" id="slot-row"></div>

    <div class="controls">
        <div class="mode-row">
            <button class="btn-mode active" id="btn-normal" onclick="setSpeed('normal')">NORMAL</button>
            <button class="btn-mode" id="btn-turbo" onclick="setSpeed('turbo')">TURBO</button>
            <button class="btn-mode" id="btn-auto" onclick="toggleAuto()">AUTO: OFF</button>
        </div>

        <div class="bet-area">
            <i class="fa-solid fa-circle-minus" style="color:var(--pink); font-size: 24px;" onclick="changeBet(-1)"></i>
            <div id="current-bet" style="color:var(--yellow); font-size:22px; font-weight:900;">400</div>
            <i class="fa-solid fa-circle-plus" style="color:var(--blue); font-size: 24px;" onclick="changeBet(1)"></i>
        </div>

        <button class="btn-play" onclick="handlePlay()">Lepaskan Bola</button>
    </div>

    <div class="nav-bottom">
        <a href="deposit.html" class="nav-item"><i class="fa-solid fa-wallet"></i>DEPOSIT</a>
        <a href="withdraw.html" class="nav-item"><i class="fa-solid fa-money-bill-transfer"></i>WITHDRAW</a>
        <a href="reward.html" class="nav-item"><i class="fa-solid fa-gift"></i>REWARD</a>
        <a href="profil.html" class="nav-item"><i class="fa-solid fa-user"></i>PROFIL</a>
    </div>

    <script src="global.js"></script>

    <script>
        // Inisialisasi variabel kunci untuk global.js
        var activeBalls = 0;
        var isSyncing = false;
        var lastWinTime = 0;
    </script>

    <script>
        const board = document.getElementById('game-board');
        const betList = [400, 800, 1000, 2000, 5000, 10000, 20000, 50000];
        const multipliers = [5, 2, 1.2, 0.5, 0.2, 0.5, 1.2, 2, 5];
        
        let betIdx = 0;
        let pegLocs = [];
        let gameSpeed = 'normal';
        let isAutoMode = false;
        let autoInterval;
        let adminWinrate = 0.5;

        // FUNGSI UPDATE UI (Helper)
        function updateSaldoUI() {
            let saldo = localStorage.getItem('user_saldo') || 0;
            const saldoEl = document.getElementById('display-saldo');
            if (saldoEl) saldoEl.innerText = "IDR " + Number(saldo).toLocaleString('id-ID');
        }

        function initPegs() {
            board.innerHTML = '';
            pegLocs = [];
            const rows = 9;
            const centerX = board.offsetWidth / 2;
            if(centerX === 0) { setTimeout(initPegs, 200); return; }

            for (let r = 2; r <= rows; r++) {
                for (let i = 0; i < r; i++) {
                    const x = centerX + (i - (r - 1) / 2) * 40;
                    const y = r * 35;
                    const peg = document.createElement('div');
                    peg.className = 'peg';
                    peg.style.left = x + 'px';
                    peg.style.top = y + 'px';
                    board.appendChild(peg);
                    pegLocs.push({ x, y, el: peg });
                }
            }

            // Create Slots
            const row = document.getElementById('slot-row');
            row.innerHTML = '';
            multipliers.forEach(m => {
                const s = document.createElement('div');
                s.className = `slot ${m >= 2 ? 's-high' : m >= 1 ? 's-mid' : 's-low'}`;
                s.innerText = m + 'x';
                row.appendChild(s);
            });
        }

        function setSpeed(mode) {
            gameSpeed = mode;
            document.getElementById('btn-normal').classList.toggle('active', mode === 'normal');
            document.getElementById('btn-turbo').classList.toggle('active', mode === 'turbo');
        }

        function toggleAuto() {
            isAutoMode = !isAutoMode;
            const btn = document.getElementById('btn-auto');
            btn.innerText = isAutoMode ? "AUTO: ON" : "AUTO: OFF";
            btn.classList.toggle('active', isAutoMode);
            if(isAutoMode) autoInterval = setInterval(handlePlay, gameSpeed === 'turbo' ? 400 : 1000);
            else clearInterval(autoInterval);
        }

        function changeBet(dir) {
            betIdx = Math.max(0, Math.min(betList.length - 1, betIdx + dir));
            document.getElementById('current-bet').innerText = betList[betIdx].toLocaleString();
        }

        function handlePlay() {
            const bet = betList[betIdx];
            let saldo = Number(localStorage.getItem('user_saldo') || 0);

            if (saldo < bet) {
                if(isAutoMode) toggleAuto();
                alert("Saldo Tidak CUKUP!");
                return;
            }

            // POTONG SALDO DI AWAL (Instan Lokal)
            localStorage.setItem('user_saldo', saldo - bet);
            updateSaldoUI();
            activeBalls++;
            playSound('drop');
            dropBall(bet);
        }

        function dropBall(bet) {
            const ball = document.createElement('div');
            ball.className = 'ball';
            board.appendChild(ball);

            let px = board.offsetWidth / 2 + (Math.random() * 4 - 2);
            let py = 10;
            let vx = (Math.random() - 0.5) * 2;
            let vy = 0;
            const gravity = 0.6;
            const bounce = 0.5;

            const anim = setInterval(() => {
                vy += gravity;
                px += vx;
                py += vy;

                pegLocs.forEach(peg => {
                    const dx = px - peg.x;
                    const dy = py - peg.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < 11) {
                        const sound = document.getElementById('sfx-hit');
                        sound.currentTime = 0; sound.play().catch(()=>{});
                        
                        vx = (dx / dist) * 2.5;
                        vy = (dy / dist) * 1.5;

                        peg.el.classList.add('hit');
                        setTimeout(() => peg.el.classList.remove('hit'), 100);
                    }
                });

                if (px < 15 || px > board.offsetWidth - 15) vx *= -0.5;

                ball.style.left = px + 'px';
                ball.style.top = py + 'px';

                if (py > 370) {
                    clearInterval(anim);
                    ball.remove();
                    activeBalls--;
                    finishGame(px, bet);
                }
            }, 1000/60);
        }

        function finishGame(x, bet) {
            const slotWidth = board.offsetWidth / multipliers.length;
            const idx = Math.floor(x / slotWidth);
            const mult = multipliers[Math.max(0, Math.min(multipliers.length - 1, idx))];
            
            // LOGIKA MATEMATIKA BENAR: 0.5x tetap dikalikan modal
            const winAmount = Math.floor(bet * mult);
            
            // 1. EFEK KOTAK MENYALA
            const slots = document.querySelectorAll('.slot');
            const s = slots[Math.max(0, Math.min(slots.length - 1, idx))];
            s.classList.add('active');
            setTimeout(() => s.classList.remove('active'), 400);

            // 2. PAPAN SCORE MELAYANG
            showFloatingScore(winAmount);

            // 3. TAMBAH SALDO LOKAL (Instan Lokal)
            let current = Number(localStorage.getItem('user_saldo') || 0);
            localStorage.setItem('user_saldo', current + winAmount);
            updateSaldoUI();

            if(mult >= 1) {
                const ws = document.getElementById('sfx-win');
                ws.currentTime = 0; ws.play().catch(()=>{});
            }

            // Kirim ke Google Sheet (lastWinTime di-update di sini untuk kunci sinkronisasi)
            syncResult(bet, mult, winAmount);
        }

        // Tampilkan Papan Skor di Pojok Kanan Atas
        function showFloatingScore(amt) {
            const fs = document.getElementById('floating-score');
            const sa = document.getElementById('score-amount');
            sa.innerText = "IDR " + amt.toLocaleString('id-ID');
            fs.style.display = 'block';
            
            // Hilangkan setelah 3 detik
            clearTimeout(window.scoreTimer);
            window.scoreTimer = setTimeout(() => {
                fs.style.display = 'none';
            }, 3000);
        }

        async function syncResult(bet, mult, win) {
            isSyncing = true;
            lastWinTime = Date.now(); // Kunci sinkronisasi dimulai
            const user = localStorage.getItem('user_session');
            
            try {
                // Ganti dengan SCRIPT_URL yang benar di global.js Anda
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'playGame',
                        username: user,
                        betAmount: bet,
                        multiplier: mult,
                        winAmount: win
                    })
                });
                const res = await response.json();
                if(res.result === "SUCCESS") {
                    // Update saldo final berdasarkan server (Google Sheets)
                    localStorage.setItem('user_saldo', res.newSaldo);
                    updateSaldoUI();
                }
            } catch(e) { console.log("Sync Error"); }
            finally {
                // Beri jeda 1 detik setelah respon server untuk membuka kunci
                setTimeout(() => { isSyncing = false; }, 1000);
            }
        }

        window.onload = () => {
            initPegs();
            updateSaldoUI();
            
            // Auto-refresh Saldo Periodik (Anti-Mental Logic)
            setInterval(() => {
                // Panggil fetchLatestSaldo dari global.js jika sudah ada
                if(typeof fetchLatestSaldo === 'function') fetchLatestSaldo();
            }, 8000);
        };
        
        window.onresize = initPegs;
    </script>
</body>
</html>
