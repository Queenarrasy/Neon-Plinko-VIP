<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON PLINKO VIP - FIXED SINKRONISASI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root { 
            --pink: #ff0077; --deep-blue: #0044ff; --yellow: #fbff00; --white: #ffffff; --bg: #03040a; 
            --pink-neon: 0 0 8px rgba(255, 0, 119, 0.4); --blue-neon: 0 0 10px rgba(0, 68, 255, 0.5);
        }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(5, 7, 20, 0.95); border-bottom: 2px solid var(--deep-blue); }
        .balance-box { background: #000; border: 2px solid var(--pink); border-radius: 50px; padding: 8px 25px; text-align: center; box-shadow: var(--pink-neon); }
        #display-saldo { font-size: 18px; font-weight: 900; color: var(--white); }
        .multipliers { display: flex; justify-content: center; gap: 4px; padding: 0 40px; height: 35px; }
        .slot { flex: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 11px; font-weight: 900; color: #000 !important; }
        .m-x2 { background: var(--yellow); } .m-x5 { background: var(--pink); } .m-x1 { background: var(--deep-blue); color: #fff !important; } .m-low { background: var(--white); }
        #game-container { position: relative; width: 100%; height: 350px; margin-top: 5px; overflow: hidden; }
        .peg { position: absolute; width: 6px; height: 6px; background: #fff; border-radius: 50%; opacity: 0.5; }
        .ball { position: absolute; width: 12px; height: 12px; background: radial-gradient(circle at 30% 30%, #fff, var(--pink)); border-radius: 50%; box-shadow: var(--pink-neon); z-index: 10; transform: translate(-50%, -50%); }
        .play-area { padding: 15px 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn-main { width: 100%; padding: 16px; border-radius: 50px; border: 2px solid var(--yellow); font-weight: 900; font-size: 16px; color: white; cursor: pointer; background: linear-gradient(90deg, #aa0055, #0022aa); }
        .win-popup { position: absolute; font-weight: 900; font-size: 22px; animation: fadeUp 0.8s forwards; z-index: 100; text-shadow: 0 0 5px black; }
        @keyframes fadeUp { 0% { opacity: 0; transform: translateY(0); } 50% { opacity: 1; } 100% { opacity: 0; transform: translateY(-40px); } }
    </style>
</head>
<body>

    <div class="header">
        <div style="text-align: center;"><i class="fa-solid fa-user-ninja" style="color:var(--pink)"></i></div>
        <div class="balance-box">
            <div style="font-size: 9px; opacity: 0.7;">SALDO ANDA</div>
            <div id="display-saldo">IDR 0</div>
        </div>
        <div style="text-align: center;"><i class="fa-solid fa-gear" style="color:var(--yellow)"></i></div>
    </div>

    <div id="game-container"></div>

    <div class="multipliers" id="multiplier-row">
        <div class="slot m-x5">5x</div><div class="slot m-x2">2x</div><div class="slot m-x1">1.2x</div>
        <div class="slot m-low">0.2x</div>
        <div class="slot m-x1">1.2x</div><div class="slot m-x2">2x</div><div class="slot m-x5">5x</div>
    </div>

    <div class="play-area">
        <div id="bet-display" style="text-align: center; font-weight: 900; color: var(--yellow); margin-bottom: 5px;">BET: 1.000</div>
        <button class="btn-main" onclick="handlePlay()">LEPASKAN BOLA</button>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzYTC11njbEBtAsdpbaRLJRt13j7iEKCkANV1SgxxguV_zFUyZ6Z7FAj0SKuw4d5ThmKw/exec";
        const container = document.getElementById('game-container');
        const slotMults = [5, 2, 1.2, 0.2, 1.2, 2, 5];
        
        // --- STATE MANAGEMENT ---
        let activeBalls = 0;
        let isSyncing = false;
        let lastWinTime = 0;

        function updateSaldoUI() {
            let saldo = localStorage.getItem('user_saldo') || 0;
            document.getElementById('display-saldo').innerText = "IDR " + Number(saldo).toLocaleString();
        }

        async function fetchLatestSaldo() {
            // LOCK: Jangan tarik data server jika ada aktivitas atau baru saja menang (< 3 detik)
            const now = Date.now();
            if (activeBalls > 0 || isSyncing || (now - lastWinTime < 3000)) return;

            try {
                const user = localStorage.getItem('user_session');
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getUserData', username: user })
                });
                const res = await response.json();
                
                // Double Check sebelum menimpa
                if (res.result === "SUCCESS" && activeBalls === 0 && !isSyncing) {
                    localStorage.setItem('user_saldo', res.saldo);
                    updateSaldoUI();
                }
            } catch (e) {}
        }

        function handlePlay() {
            const bet = 1000; // Sesuai permintaan Anda
            let saldo = Number(localStorage.getItem('user_saldo') || 0);
            
            if (saldo < bet) return alert("Saldo Kurang!");

            // 1. Kurangi Lokal Langsung
            saldo -= bet;
            localStorage.setItem('user_saldo', saldo);
            updateSaldoUI();
            
            activeBalls++;
            dropBall(bet);
        }

        function dropBall(bet) {
            const ballEl = document.createElement('div');
            ballEl.className = 'ball';
            container.appendChild(ballEl);
            
            let x = container.offsetWidth / 2;
            let y = 10; let vx = (Math.random() - 0.5) * 2; let vy = 0;

            const anim = setInterval(() => {
                vy += 0.25; x += vx; y += vy;
                ballEl.style.left = x + 'px'; ballEl.style.top = y + 'px';

                if (y > 340) {
                    clearInterval(anim);
                    ballEl.remove();
                    activeBalls--;
                    calculateWin(x, bet);
                }
            }, 1000/60);
        }

        function calculateWin(finalX, bet) {
            const winIdx = Math.floor((finalX / container.offsetWidth) * slotMults.length);
            const multiplier = slotMults[Math.min(winIdx, 6)];
            const winAmount = Math.floor(bet * multiplier);

            // 2. Tambah Lokal Langsung (Sangat Penting)
            let currentSaldo = Number(localStorage.getItem('user_saldo') || 0);
            localStorage.setItem('user_saldo', currentSaldo + winAmount);
            updateSaldoUI();
            
            lastWinTime = Date.now(); // Catat waktu menang untuk Cooldown
            showWinPopup(winAmount, finalX);
            syncWinToServer(bet, multiplier);
        }

        async function syncWinToServer(bet, mult) {
            isSyncing = true;
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: 'playGame', 
                        username: localStorage.getItem('user_session'),
                        betAmount: bet, multiplier: mult, isClientHandled: true 
                    })
                });
                const res = await response.json();
                if (res.result === "SUCCESS") {
                    // Update ke saldo final dari server jika perlu
                    localStorage.setItem('user_saldo', res.newSaldo);
                    updateSaldoUI();
                }
            } catch (e) {
            } finally {
                // Beri waktu 2 detik tambahan setelah respon server diterima
                setTimeout(() => { isSyncing = false; }, 2000);
            }
        }

        function showWinPopup(amt, x) {
            const p = document.createElement('div');
            p.className = 'win-popup';
            p.innerText = "+" + amt.toLocaleString();
            p.style.left = x + 'px'; p.style.top = '280px';
            p.style.color = amt >= 1000 ? 'var(--yellow)' : 'white';
            container.appendChild(p);
            setTimeout(() => p.remove(), 800);
        }

        function initPegs() {
            for (let r = 2; r <= 9; r++) {
                for (let i = 0; i < r; i++) {
                    const peg = document.createElement('div');
                    peg.className = 'peg';
                    peg.style.left = (container.offsetWidth/2 + (i - (r-1)/2) * 40) + 'px';
                    peg.style.top = (r * 35) + 'px';
                    container.appendChild(peg);
                }
            }
        }

        window.onload = () => {
            initPegs();
            updateSaldoUI();
            setInterval(fetchLatestSaldo, 5000); // Cek server tiap 5 detik
        };
    </script>
</body>
</html>
