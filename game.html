<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON PLINKO VIP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --pink: #ff0077;
            --blue: #0044ff;
            --yellow: #fbff00;
            --white: #ffffff;
            --bg: #03040a;
            --neon-pink: 0 0 15px var(--pink), 0 0 30px var(--pink);
            --neon-blue: 0 0 15px var(--blue);
            --neon-white: 0 0 10px var(--white);
        }

        body {
            background: var(--bg);
            color: white;
            font-family: 'Arial', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* HEADER & SALDO */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid var(--blue);
        }

        .balance-container {
            text-align: center;
            background: #000;
            padding: 5px 20px;
            border: 2px solid var(--pink);
            border-radius: 30px;
            box-shadow: var(--neon-pink);
        }

        #display-saldo {
            font-size: 18px;
            font-weight: 900;
            color: var(--white);
            text-shadow: 0 0 5px var(--white);
        }

        /* GAME AREA */
        #game-board {
            position: relative;
            width: 100%;
            height: 400px;
            background: radial-gradient(circle at center, #0a0b1e 0%, #03040a 100%);
            overflow: visible;
        }

        .peg {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--white);
            border-radius: 50%;
            box-shadow: var(--neon-white);
            transform: translate(-50%, -50%);
            z-index: 5;
            transition: all 0.1s;
        }

        .peg.hit {
            background: var(--yellow);
            box-shadow: 0 0 20px var(--yellow);
            transform: translate(-50%, -50%) scale(1.5);
        }

        .ball {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--pink);
            border-radius: 50%;
            box-shadow: var(--neon-pink);
            z-index: 10;
            transform: translate(-50%, -50%);
        }

        /* MULTIPLIERS */
        .multiplier-row {
            display: flex;
            justify-content: center;
            gap: 4px;
            padding: 0 10px;
            margin-bottom: 10px;
        }

        .slot {
            flex: 1;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 900;
            border-radius: 5px;
            color: #000;
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.2s;
        }

        .slot.active { transform: scale(1.1); filter: brightness(1.5); }
        .s-high { background: var(--pink); box-shadow: 0 0 10px var(--pink); }
        .s-mid { background: var(--yellow); box-shadow: 0 0 10px var(--yellow); }
        .s-low { background: var(--blue); color: white; }

        /* CONTROLS */
        .controls {
            padding: 10px;
            background: #050714;
            border-top: 2px solid var(--blue);
        }

        .speed-bar {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }

        .btn-speed {
            background: transparent;
            border: 1px solid var(--blue);
            color: var(--blue);
            padding: 5px 15px;
            border-radius: 10px;
            font-size: 10px;
            cursor: pointer;
        }

        .btn-speed.active {
            background: var(--blue);
            color: white;
            box-shadow: var(--neon-blue);
        }

        .bet-area {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .bet-btn {
            background: linear-gradient(45deg, var(--blue), var(--pink));
            border: none;
            color: white;
            width: 100%;
            padding: 15px;
            border-radius: 15px;
            font-weight: 900;
            font-size: 16px;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(255, 0, 119, 0.4);
        }

        /* NAV BOTTOM */
        .nav-bottom {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            text-align: center;
            padding: 10px 0;
            background: #000;
        }

        .nav-item { color: var(--white); font-size: 10px; text-decoration: none; opacity: 0.7; }
        .nav-item i { font-size: 18px; margin-bottom: 4px; display: block; }
        .nav-item.active { opacity: 1; color: var(--yellow); }
    </style>
</head>
<body>

    <div class="header">
        <div onclick="location.href='profil.html'"><i class="fa-solid fa-circle-user" style="color: var(--yellow); font-size: 25px;"></i></div>
        <div class="balance-container">
            <div style="font-size: 8px; color: var(--pink);">TOTAL BALANCE</div>
            <div id="display-saldo">IDR 0</div>
        </div>
        <div onclick="location.href='settings.html'"><i class="fa-solid fa-bars-staggered" style="color: var(--pink); font-size: 22px;"></i></div>
    </div>

    <div id="game-board"></div>

    <div class="multiplier-row" id="slots">
        </div>

    <div class="controls">
        <div class="speed-bar">
            <button class="btn-speed active" onclick="setSpeed('normal', this)">NORMAL</button>
            <button class="btn-speed" onclick="setSpeed('turbo', this)">TURBO</button>
            <button class="btn-speed" id="btn-auto" onclick="toggleAuto()">AUTO: OFF</button>
        </div>

        <div class="bet-area">
            <i class="fa-solid fa-minus" onclick="changeBet(-1)" style="color: var(--pink)"></i>
            <div style="text-align: center">
                <span style="font-size: 10px; color: gray;">BET AMOUNT</span>
                <div id="current-bet" style="font-size: 20px; font-weight: 900; color: var(--yellow);">400</div>
            </div>
            <i class="fa-solid fa-plus" onclick="changeBet(1)" style="color: var(--blue)"></i>
        </div>

        <button class="bet-btn" onclick="placeBet()">Play Ball</button>
    </div>

    <div class="nav-bottom">
        <a href="deposit.html" class="nav-item"><i class="fa-solid fa-wallet"></i>Deposit</a>
        <a href="withdraw.html" class="nav-item"><i class="fa-solid fa-money-bill-transfer"></i>Withdraw</a>
        <a href="reward.html" class="nav-item"><i class="fa-solid fa-gift"></i>Reward</a>
        <a href="profil.html" class="nav-item"><i class="fa-solid fa-user"></i>Profile</a>
    </div>

    <script src="global.js"></script>
    <script>
        const board = document.getElementById('game-board');
        const slotContainer = document.getElementById('slots');
        const betList = [400, 800, 1200, 2000, 5000, 10000, 20000, 50000];
        const multipliers = [10, 5, 2, 1.2, 0.5, 0.2, 0.5, 1.2, 2, 5, 10];
        
        let currentBetIdx = 0;
        let pegLocs = [];
        let speed = 'normal';
        let isAuto = false;
        let autoInterval;
        let winrate = 0.5; // Bisa ditarik dari Sheet Admin

        // Init Paku & Slot
        function initBoard() {
            board.innerHTML = '';
            pegLocs = [];
            const rows = 10;
            const spacingX = 35;
            const spacingY = 32;

            for (let r = 2; r <= rows; r++) {
                for (let i = 0; i < r; i++) {
                    const x = board.offsetWidth / 2 + (i - (r - 1) / 2) * spacingX;
                    const y = r * spacingY;
                    const peg = document.createElement('div');
                    peg.className = 'peg';
                    peg.style.left = x + 'px';
                    peg.style.top = y + 'px';
                    board.appendChild(peg);
                    pegLocs.push({ x, y, el: peg });
                }
            }

            // Create Slots
            slotContainer.innerHTML = '';
            multipliers.forEach(m => {
                const div = document.createElement('div');
                div.className = `slot ${m >= 5 ? 's-high' : m >= 1 ? 's-mid' : 's-low'}`;
                div.innerText = m + 'x';
                slotContainer.appendChild(div);
            });
        }

        function setSpeed(mode, btn) {
            speed = mode;
            document.querySelectorAll('.btn-speed').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function changeBet(dir) {
            currentBetIdx = Math.max(0, Math.min(betList.length - 1, currentBetIdx + dir));
            document.getElementById('current-bet').innerText = betList[currentBetIdx].toLocaleString();
        }

        function toggleAuto() {
            isAuto = !isAuto;
            const btn = document.getElementById('btn-auto');
            if(isAuto) {
                btn.classList.add('active');
                btn.innerText = "AUTO: ON";
                autoInterval = setInterval(placeBet, speed === 'turbo' ? 400 : 1200);
            } else {
                btn.classList.remove('active');
                btn.innerText = "AUTO: OFF";
                clearInterval(autoInterval);
            }
        }

        async function placeBet() {
            const bet = betList[currentBetIdx];
            let saldo = Number(localStorage.getItem('user_saldo') || 0);

            if (saldo < bet) {
                alert("Saldo tidak cukup!");
                if(isAuto) toggleAuto();
                return;
            }

            // Potong Saldo Langsung (Client Side)
            saldo -= bet;
            localStorage.setItem('user_saldo', saldo);
            updateSaldoUI();

            spawnBall(bet);
        }

        function spawnBall(bet) {
            const ball = document.createElement('div');
            ball.className = 'ball';
            board.appendChild(ball);

            let posX = board.offsetWidth / 2 + (Math.random() * 4 - 2);
            let posY = 20;
            let vx = (Math.random() - 0.5) * 1.5;
            let vy = 0;
            const gravity = 0.6;
            const friction = 0.98;

            const move = setInterval(() => {
                vy += gravity;
                vx *= friction;
                posX += vx;
                posY += vy;

                // Logika Pantulan Paku
                pegLocs.forEach(peg => {
                    const dx = posX - peg.x;
                    const dy = posY - peg.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if (dist < 10) {
                        // Rumus Winrate: Jika winrate rendah, paksa vx ke arah tengah
                        const bias = (Math.random() > winrate) ? (board.offsetWidth/2 - posX) * 0.05 : 0;
                        
                        vx = (dx / dist) * 3 + bias;
                        vy = (dy / dist) * 2;
                        
                        peg.el.classList.add('hit');
                        setTimeout(() => peg.el.classList.remove('hit'), 100);
                    }
                });

                ball.style.left = posX + 'px';
                ball.style.top = posY + 'px';

                // Cek jika masuk slot
                if (posY > 390) {
                    clearInterval(move);
                    ball.remove();
                    calcResult(posX, bet);
                }
            }, 1000/60);
        }

        function calcResult(finalX, bet) {
            const slotWidth = board.offsetWidth / multipliers.length;
            const idx = Math.floor(finalX / slotWidth);
            const mult = multipliers[Math.max(0, Math.min(multipliers.length - 1, idx))];
            
            const winAmount = Math.floor(bet * mult);
            
            // Efek Visual Slot
            const slots = document.querySelectorAll('.slot');
            const targetSlot = slots[Math.max(0, Math.min(slots.length - 1, idx))];
            targetSlot.classList.add('active');
            setTimeout(() => targetSlot.classList.remove('active'), 300);

            // Update Saldo Server & Local
            syncResult(bet, mult, winAmount);
        }

        async function syncResult(bet, mult, win) {
            const user = localStorage.getItem('user_session');
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'playGame',
                        username: user,
                        betAmount: bet,
                        multiplier: mult,
                        winAmount: win
                    })
                });
                const res = await response.json();
                if(res.result === "SUCCESS") {
                    localStorage.setItem('user_saldo', res.newSaldo);
                    updateSaldoUI();
                }
            } catch(e) {
                console.error("Sync Error");
            }
        }

        window.onload = () => {
            initBoard();
            updateSaldoUI();
        };
    </script>
</body>
</html>
